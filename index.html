<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football TV Hub</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { color: #00ff88; text-align: center; margin-bottom: 30px; }
        .loading { text-align: center; font-size: 1.2em; color: #888; }
        
        .alert { background: #ff4444; color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        
        .match-card {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
        }
        .match-info { flex: 1; min-width: 200px; }
        .teams { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .meta { color: #888; font-size: 0.9em; }
        .league-badge { background: #333; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 5px; border: 1px solid #444;}
        .live-dot { color: #ff4444; font-weight: bold; animation: pulse 1.5s infinite; }

        .btn { text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; display: inline-block; text-align: center; cursor: pointer; border: none; font-size: 0.9em;}
        .btn-play { background-color: #00ff88; color: #000; box-shadow: 0 0 10px rgba(0,255,136,0.2); }
        .btn-play:hover { background-color: #00cc6a; }
        .btn-search { background-color: #2c2c2c; color: #ccc; border: 1px solid #444; }
        .btn-search:hover { background-color: #3c3c3c; color: #fff; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>‚öΩ Football TV Hub</h1>
    <div id="error-box" class="alert"></div>
    <div id="matches-container" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π –∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞...</div>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const API_KEY = '6b86c33cb76a4ed58d581bda6df30151'; // –¢–≤–æ–π –∫–ª—é—á
        const PLAYLIST_FILE = 'playlist.m3u'; // –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html –Ω–∞ GitHub
        const LEAGUES = 'PL,PD,SA,BL1,FL1,CL'; 

        // –ü—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS (—á—Ç–æ–±—ã API —Ä–∞–±–æ—Ç–∞–ª–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        const PROXY_URL = 'https://api.allorigins.win/raw?url='; 
        const API_URL = `https://api.football-data.org/v4/matches?competitions=${LEAGUES}`;

        // --- –õ–û–ì–ò–ö–ê ---

        async function init() {
            const container = document.getElementById('matches-container');
            const errorBox = document.getElementById('error-box');

            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û (–ú–∞—Ç—á–∏ + –ü–ª–µ–π–ª–∏—Å—Ç)
                const [matchesData, playlistText] = await Promise.all([
                    fetchMatches(),
                    fetchPlaylist()
                ]);

                // 2. –ü–∞—Ä—Å–∏–º –ø–ª–µ–π–ª–∏—Å—Ç
                const channels = parsePlaylist(playlistText);
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: ${channels.length}`);

                // 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Ç—á–∏
                container.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å "–ó–∞–≥—Ä—É–∑–∫—É"
                
                if (matchesData.matches.length === 0) {
                    container.innerHTML = '<div style="text-align:center">–ú–∞—Ç—á–µ–π –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 48 —á–∞—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
                    return;
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                matchesData.matches.sort((a, b) => new Date(a.utcDate) - new Date(b.utcDate));

                matchesData.matches.forEach(match => {
                    renderMatch(match, channels, container);
                });

            } catch (err) {
                console.error(err);
                container.innerHTML = '';
                errorBox.style.display = 'block';
                errorBox.innerHTML = `‚ö†Ô∏è –û—à–∏–±–∫–∞: ${err.message}<br>–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
            }
        }

        async function fetchMatches() {
            // –ë–µ—Ä–µ–º –º–∞—Ç—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –∑–∞–≤—Ç—Ä–∞
            const dateFrom = new Date().toISOString().split('T')[0];
            const dateTo = new Date(Date.now() + 2 * 86400000).toISOString().split('T')[0];
            
            const url = `${PROXY_URL}${encodeURIComponent(API_URL + `&dateFrom=${dateFrom}&dateTo=${dateTo}`)}`;
            
            const response = await fetch(url, {
                headers: { 'X-Auth-Token': API_KEY }
            });
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å Football API');
            return await response.json();
        }

        async function fetchPlaylist() {
            try {
                const response = await fetch(PLAYLIST_FILE);
                if (!response.ok) return null; // –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
                return await response.text();
            } catch (e) {
                console.warn("–ü–ª–µ–π–ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
                return null;
            }
        }

        function parsePlaylist(text) {
            if (!text) return [];
            const lines = text.split('\n');
            const channels = [];
            let currentTitle = null;

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const parts = line.split(',');
                    if (parts.length > 1) currentTitle = parts.slice(1).join(',').trim();
                } else if (line.startsWith('acestream://') && currentTitle) {
                    channels.push({
                        name: currentTitle,
                        id: line.replace('acestream://', '')
                    });
                    currentTitle = null;
                }
            });
            return channels;
        }

        // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–Ω–µ—á–µ—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞" –Ω–∞ JS
        function findLink(home, away, channels) {
            if (!channels.length) return null;

            const query = [
                `${home} ${away}`.toLowerCase(),
                `${home} vs ${away}`.toLowerCase(),
                `${away} ${home}`.toLowerCase()
            ];

            // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–ª–æ–≤–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞
            // –ù–∞–ø—Ä–∏–º–µ—Ä "Man United" -> ["man", "united"]
            const homeWords = home.toLowerCase().split(' ');
            const awayWords = away.toLowerCase().split(' ');

            for (let ch of channels) {
                const chName = ch.name.toLowerCase();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞ –•–û–¢–Ø –ë–´ –æ–¥–Ω–æ —Å–ª–æ–≤–æ –æ—Ç —Ö–æ–∑—è–µ–≤ –ò –æ–¥–Ω–æ —Å–ª–æ–≤–æ –æ—Ç –≥–æ—Å—Ç–µ–π
                // –≠—Ç–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–æ–≥ Python fuzzy search
                const hasHome = homeWords.some(w => w.length > 2 && chName.includes(w));
                const hasAway = awayWords.some(w => w.length > 2 && chName.includes(w));

                if (hasHome && hasAway) {
                    return `http://127.0.0.1:6878/ace/getstream?id=${ch.id}`;
                }
            }
            return null;
        }

        function renderMatch(match, channels, container) {
            const date = new Date(match.utcDate);
            const timeStr = date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            const dateStr = date.toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'});
            
            const home = match.homeTeam.name;
            const away = match.awayTeam.name;
            
            // –ò—â–µ–º —Å—Å—ã–ª–∫—É
            const aceLink = findLink(home, away, channels);
            
            const isLive = match.status === 'IN_PLAY' || match.status === 'PAUSED';

            const div = document.createElement('div');
            div.className = 'match-card';
            div.innerHTML = `
                <div class="match-info">
                    <div class="meta">
                        <span class="league-badge">${match.competition.name}</span>
                        ${isLive ? '<span class="live-dot">‚óè LIVE</span>' : `${dateStr} –≤ ${timeStr}`}
                    </div>
                    <div class="teams">${home} ‚Äî ${away}</div>
                </div>
                <div>
                    ${aceLink 
                        ? `<a href="${aceLink}" class="btn btn-play">‚ñ∂ –°–º–æ—Ç—Ä–µ—Ç—å</a>`
                        : `<a href="https://www.google.com/search?q=site:search-ace.stream+${home}+${away}" target="_blank" class="btn btn-search">üîç –ù–∞–π—Ç–∏ ID</a>`
                    }
                </div>
            `;
            container.appendChild(div);
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>

</html>
